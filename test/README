 `run_test` 路径就是“无监督流形学习→3D坐标”的套路：
先基于分子图与原子/键特征构造高维“相似度/距离”，用二分法自适应得到模糊邻接概率 $P$（类似 UMAP 的 fuzzy union），再用谱嵌入得到 3D 初始化 $Y$，最后以交叉熵损失对 $Y$ 做梯度下降并可视化优化过程。核心步骤在代码里分别是：

* 三种原子对距离：结构增强图距离 $D_1$（`compute_augmented_graph_distance`）、原子环境 AE-Tanimoto 距离 $D_2$、以及 RDKit 的 3D 嵌入后欧氏距离 $D_3$（用于对照/评估），随后选用 $D_1$ 作为本次无监督优化的“高维”度量（`dist = D1`）。   &#x20;
* 自适应带宽 $\sigma$ 的二分搜索得到逐行概率并用“模糊并集”得对称 $P$。 &#x20;
* 用谱嵌入（precomputed affinity）初始化三维坐标 $Y$，并按 $\min\_dist$ 拟合出低维相似度函数参数 $a,b$。&#x20;
* 定义低维概率 $Q(Y)$ 与交叉熵 $CE(P,Q)$ 及其梯度，做迭代更新并定期输出帧图。 &#x20;

下面给几个**有助于提升几何合理性与收敛稳定性**的改进点（都很容易落地）：

1. 真正“解耦”拓扑与边属性
   现在的 $D_{\text{edge}}$ 与 $D_{\text{topo}}$ 都基于同一个边权 `weight=np.linalg.norm(edge_feat)` 的路径累加——本质上会重复计数边特征范数（一个通过手动路径累积、一个通过 Dijkstra），导致 $D_{\text{edge}}$ 与 $D_{\text{topo}}$ 强相关。建议：

* 令 $D_{\text{topo}}$ 使用**无权**图（每条键长度=1，只反映“跳数”）；
* 把当前按边特征范数累加的那条保留为 $D_{\text{edge}}$。
  这样 $D_{\text{aug}}=D_{\text{topo}}+\alpha D_{\text{feat}}+\beta D_{\text{edge}}$ 才更有“形状+理化属性”的互补性。现在的实现里两者都用 `weight='weight'` 与范数累加，正是耦合的根源。 &#x20;

2. 允许多源度量的可调融合
   现在固定 `dist = D1`。很多分子上，加入 AE 局部环境有助于约束近邻次序；可考虑

$$
\text{dist} = w_1 \,\hat D_1 + w_2 \,\hat D_2 + w_3 \,\hat D_3
$$

其中 $\hat D$ 为各自 min-max 归一化，$w$ 可网格或小步随机搜索（如 $w_3=0$ 保持“无监督”，只用 $D_1,D_2$）。实现位置就在 `dist = D1` 这一行附近。

3. 低维初始化与尺度
   初始化后做了 `Y /= Y.max()`，这会把一维上极端点定到 1 而非保整体尺度关系；更稳妥：`Y -= Y.mean(0)` 使其居中，整体缩放用**中位数邻接距离**或单位方差，而不是 `max()`。对应初始化段落：

4. 几何物理约束（软约束项）
   在 CE 之外，加一个**键长/键角弹簧**正则（只对成键原子对），如

$$
\lambda_b \sum_{(i,j)\in E}\big(\|Y_i-Y_j\| - \ell_{ij}\big)^2
$$

$\ell_{ij}$ 可取经验键长或简单常量（同键类型同值）；再加**手性/平面**软约束（例如对手性中心的四元体用定向体积符号保持）。这些项对收敛到“化学可行”的 3D 形状很关键，而不会破坏“无监督”的精神。

5. 训练细节与数值稳定

* 学习率 `lr=1` 偏大，建议从 `1e-2 ~ 5e-2` 起，用 Adam；
* `CE` 里 log 的 $\epsilon$ 取 `1e-6` 更合适，`0.01` 会偏大（改变最优点）；
* 先做 50\~100 步“夸大吸引力”（early exaggeration）再恢复正常，有助于分离近邻后再细化。对应现在的实现位置：学习率与 CE 的 epsilon。&#x20;

6. 复杂度与加速
   `D_edge` 目前双重 for + 路径还原，$O(N^3)$ 且开销大；若仍采用“按边特征范数求和”的路径代价，可直接对带权图跑**一次** all-pairs shortest path（或对每个源一次 Dijkstra，复用长度而非回溯路径），能显著提速。对应循环在：

7. 评估与对齐
   虽然训练是“无监督”，但可以把最终 $Y$ 与 RDKit ETKDG 的 3D（已在 `compute_embed3d_distance` 里得到）做 Procrustes/RMSD 对齐做**离线评估**；已有 `D3` 与可视化管线，差一步就能生成量化指标。

